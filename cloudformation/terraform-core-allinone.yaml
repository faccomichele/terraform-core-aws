AWSTemplateFormatVersion: '2010-09-09'
Description: 'Terraform State Management Infrastructure - Core resources (S3, IAM, and SSM in a single stack)'

# Stack Name: terraform-core-allinone

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Project Configuration
        Parameters:
          - ProjectName
          - Organization
          - Environment
    ParameterLabels:
      ProjectName:
        default: Project Name
      Organization:
        default: Organization Name
      Environment:
        default: Environment/Workspace

Parameters:
  ProjectName:
    Type: String
    Description: Name of the project
    Default: terraform-core-aws
    MinLength: 1
    MaxLength: 63
    AllowedPattern: ^[a-z0-9-]+$
    ConstraintDescription: Must be lowercase alphanumeric with hyphens only
  
  Organization:
    Type: String
    Description: Name of the organization
    Default: faccomichele
    MinLength: 1
    MaxLength: 63
    AllowedPattern: ^[a-z0-9-]+$
    ConstraintDescription: Must be lowercase alphanumeric with hyphens only
  
  Environment:
    Type: String
    Description: Environment/Workspace (dev, stg, prod)
    AllowedValues:
      - dev
      - stg
      - prod
    Default: dev

Resources:
  # S3 bucket for Terraform state files
  TerraformStateBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ProjectName}-state-files-${Environment}-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
            BucketKeyEnabled: true
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: terraform-state-files-lifecycle
            Status: Enabled
            NoncurrentVersionExpiration:
              NoncurrentDays: 30
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Organization
          Value: !Ref Organization
        - Key: Environment
          Value: !Ref Environment
        - Key: RepositoryURL
          Value: !Sub 'https://github.com/${Organization}/${ProjectName}'
        - Key: Automation
          Value: CloudFormation
        - Key: RepositoryPath
          Value: '.'
        - Key: RepositoryFile
          Value: cloudformation/terraform-core-allinone.yaml
        - Key: Name
          Value: !Sub '${ProjectName}-state-files-${Environment}'
        - Key: Description
          Value: S3 bucket for storing Terraform state files

  # IAM role for Terraform state access
  TerraformStateRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Ref AWS::AccountId
            Action: sts:AssumeRole
      Policies:
        - PolicyName: terraform-state-files-inline-policy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: ListObjectsInBucket
                Effect: Allow
                Action:
                  - s3:ListBucket
                Resource: !GetAtt TerraformStateBucket.Arn
              - Sid: AllObjectActions
                Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                Resource: !Sub '${TerraformStateBucket.Arn}/*'
      Tags:
        - Key: Project
          Value: !Ref ProjectName
        - Key: Organization
          Value: !Ref Organization
        - Key: Environment
          Value: !Ref Environment
        - Key: RepositoryURL
          Value: !Sub 'https://github.com/${Organization}/${ProjectName}'
        - Key: Automation
          Value: CloudFormation
        - Key: RepositoryPath
          Value: '.'
        - Key: RepositoryFile
          Value: cloudformation/terraform-core-allinone.yaml
        - Key: Description
          Value: IAM role for accessing Terraform state files

  # Standalone IAM managed policy for SSM parameter read access
  SSMParameterReadPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub '${ProjectName}-ssm-read-${Environment}'
      Description: Allows read access to Terraform backend configuration SSM parameter
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: ReadBackendConfiguration
            Effect: Allow
            Action:
              - ssm:GetParameter
              - ssm:GetParameters
            Resource: !Sub 'arn:aws:ssm:*:${AWS::AccountId}:parameter/terraform-core-aws/${Environment}/backend_configuration_hcl'

  # SSM parameter for backend configuration
  BackendConfigurationParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub '/${ProjectName}/${Environment}/backend_configuration_hcl'
      Description: Backend configuration in HCL format for copy-paste into other Terraform configurations
      Type: String
      Value: !Sub |
        terraform {
          backend "s3" {
            bucket        = "${TerraformStateBucket}"
            key           = "CHANGE_ME/terraform.tfstate"
            region        = "${AWS::Region}"
            assume_role = {
              role_arn      = "${TerraformStateRole.Arn}"
            }
            encrypt       = true
            use_lockfile  = true
          }
        }
      Tags:
        Project: !Ref ProjectName
        Organization: !Ref Organization
        Environment: !Ref Environment
        RepositoryURL: !Sub 'https://github.com/${Organization}/${ProjectName}'
        Automation: CloudFormation
        RepositoryPath: '.'
        RepositoryFile: cloudformation/terraform-core-allinone.yaml
        Name: !Sub '/${ProjectName}/${Environment}/backend_configuration_hcl'
        Description: Backend configuration in HCL format for copy-paste into other Terraform configurations
